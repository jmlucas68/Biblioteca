<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mi Biblioteca Personal</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: #f5f7fb; margin:0; }
    .container { max-width: 1200px; margin: 0 auto; padding: 18px; }
    header { background:#1f2937; color:#fff; padding:18px; border-radius:12px; }
    header h1 { margin:0 0 6px 0; font-size:22px; }
    .stats { display:flex; gap:24px; font-size:14px; opacity:.9; }
    .controls { display:flex; gap:8px; flex-wrap:wrap; padding:12px 0; }
    .controls input, .controls select { padding:10px 12px; border-radius:8px; border:1px solid #cfd8e3; background:#fff; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap:14px; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; display:flex; gap:12px; padding:12px; }
    .cover-wrap { position: relative; flex:0 0 110px; }
    .cover { width:110px; height:150px; border-radius:8px; background:#eef2f6; object-fit:cover; cursor:pointer; display:block; }
    .content { flex:1; display:flex; flex-direction:column; gap:6px; }
    .title { font-weight:700; color:#111827; line-height:1.2; }
    .author { color:#6b7280; font-size:14px; }
    .meta { display:flex; flex-wrap:wrap; gap:10px; font-size:12px; color:#374151; }
    .badge { padding:2px 8px; border-radius:999px; font-weight:600; }
    .badge.series { background:#eef2ff; color:#4338ca; }
    .badge.genre { background:#ecfeff; color:#0369a1; }
    .desc { color:#4b5563; font-size:13px; max-height:3.6em; overflow:hidden; }
    .formats { display:flex; gap:6px; flex-wrap:wrap; margin-top:4px; }
    .format-tile { font-size:12px; border:1px solid #d1d5db; border-radius:8px; padding:4px 8px; background:#f9fafb; }
    .actions { display:flex; gap:8px; align-items:center; margin-top:6px; flex-wrap:wrap; }
    .format-select { padding:8px; border-radius:8px; border:1px solid #cfd8e3; background:#fff; }
    .btn { padding:8px 12px; border:none; border-radius:8px; background:#2563eb; color:#fff; font-weight:700; cursor:pointer; }
    .btn.secondary { background:#6b7280; }
    .btn.ghost { background:#eef2f7; color:#1f2937; }
    .viewer { margin-top:10px; width:100%; height:360px; border:0; border-radius:8px; background:#f0f2f5; display:none; }
    .no-results { text-align:center; color:#6b7280; padding:40px 0; }

    /* Modal */
    .modal-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,.45);
      display: none; align-items: center; justify-content: center; padding: 16px; z-index: 50;
    }
    .modal {
      width: min(800px, 100%); background: #fff; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,.2);
      max-height: 80vh; display: flex; flex-direction: column; overflow: hidden;
    }
    .modal-header { padding: 14px 16px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-weight: 700; color: #111827; margin: 0; }
    .modal-close { background: transparent; border: none; font-size: 22px; line-height: 1; cursor: pointer; color: #6b7280; }
    .modal-body { padding: 16px; overflow: auto; color: #111827; }
    .modal-footer { padding: 12px 16px; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 8px; }
    @media (max-width: 480px) {
      .card { flex-direction:column; align-items:center; }
      .cover-wrap { flex: 0 0 auto; }
      .cover { width:160px; height:220px; }
      .content { width:100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìö Mi Biblioteca Personal</h1>
      <div class="stats">
        <div>Total obras: <b id="statTotal">0</b></div>
        <div>Autores: <b id="statAuthors">0</b></div>
      </div>
    </header>

    <div class="controls">
      <input id="q" type="search" placeholder="Buscar por t√≠tulo, autor o g√©nero..." />
      <select id="author"><option value="">Todos los autores</option></select>
      <select id="format"><option value="">Todos los formatos</option></select>
      <select id="genre"><option value="">Todos los g√©neros</option></select>
    </div>

    <div id="grid" class="grid"></div>
    <div id="noResults" class="no-results" style="display:none;">No se encontraron resultados</div>
  </div>

  <!-- Modal reutilizable -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modalTitle" class="modal-title">Descripci√≥n</h2>
        <button class="modal-close" aria-label="Cerrar" onclick="closeModal()">√ó</button>
      </div>
      <div id="modalBody" class="modal-body"></div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal()">Cerrar</button>
      </div>
    </div>
  </div>

  <script>
    let books = [];
    let filtered = [];

    document.addEventListener('DOMContentLoaded', async () => {
      await loadJson();
      initFilters();
      applyFilters();

      // Cerrar modal con Escape y clic fuera
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeModal();
      });
      document.getElementById('modalBackdrop').addEventListener('click', (e) => {
        if (e.target.id === 'modalBackdrop') closeModal();
      });
    });

    async function loadJson() {
      const res = await fetch('catalogo_biblioteca.json');
      if (!res.ok) {
        showError('No se pudo cargar catalogo_biblioteca.json');
        return;
      }
      books = await res.json();
      books.forEach(b => {
        if (!Array.isArray(b.formatos)) b.formatos = [];
        b._genres = (b.genero || '')
          .split(',')
          .map(g => g.trim())
          .filter(Boolean);
      });
      document.getElementById('statTotal').textContent = books.length;
      document.getElementById('statAuthors').textContent = new Set(books.map(b => b.autor)).size;
    }

    function initFilters() {
      fillSelect('author', [...new Set(books.map(b => b.autor))].sort());
      const allFormats = new Set();
      books.forEach(b => b.formatos.forEach(f => allFormats.add(f.formato)));
      fillSelect('format', [...allFormats].sort());
      const allGenres = new Set();
      books.forEach(b => b._genres.forEach(g => allGenres.add(g)));
      fillSelect('genre', [...allGenres].sort());

      document.getElementById('q').addEventListener('input', applyFilters);
      document.getElementById('author').addEventListener('change', applyFilters);
      document.getElementById('format').addEventListener('change', applyFilters);
      document.getElementById('genre').addEventListener('change', applyFilters);
    }

    function fillSelect(id, values) {
      const sel = document.getElementById(id);
      values.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        sel.appendChild(opt);
      });
    }

    function applyFilters() {
      const q = document.getElementById('q').value.toLowerCase();
      const a = document.getElementById('author').value;
      const f = document.getElementById('format').value;
      const g = document.getElementById('genre').value;

      filtered = books.filter(b => {
        const matchesQ = !q ||
          (b.titulo && b.titulo.toLowerCase().includes(q)) ||
          (b.autor && b.autor.toLowerCase().includes(q)) ||
          (b.genero && b.genero.toLowerCase().includes(q));
        const matchesA = !a || b.autor === a;
        const matchesF = !f || (b.formatos || []).some(x => x.formato === f);
        const matchesG = !g || b._genres.includes(g);
        return matchesQ && matchesA && matchesF && matchesG;
      });

      render();
    }

    function render() {
      const grid = document.getElementById('grid');
      const empty = document.getElementById('noResults');
      if (!filtered.length) {
        grid.innerHTML = '';
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';
      grid.innerHTML = filtered.map(renderCard).join('');
    }

    function renderCard(b) {
      const viewerId = 'viewer_' + hash(b.titulo + '|' + b.autor + '|' + (b.carpetaObra || ''));
      const selectId = 'sel_' + viewerId;
      const portadaSrc = resolveCoverThumb(b.urlPortada);
      const coverHref = b.urlPortada || '#';
      const series = b.serie ? `<span class="badge series">${esc(b.serie)}${b.numeroSerie ? ' #' + esc(b.numeroSerie) : ''}</span>` : '';
      const genres = b._genres.slice(0, 3).map(g => `<span class="badge genre">${esc(g)}</span>`).join(' ');
      const year = safeYear(b.fechaPublicacion);

      const options = (b.formatos || []).map(f => {
        const preview = buildPreviewUrl(f.url);
        const size = f.tamano ? ` ‚Äî ${esc(f.tamano)}` : '';
        return `<option value="${esc(f.url)}" data-preview="${esc(preview)}">${esc(f.formato)}${size}</option>`;
      }).join('');

      const tiles = (b.formatos || []).map(f => `<span class="format-tile">${esc(f.formato)}${f.tamano ? ' ¬∑ ' + esc(f.tamano) : ''}</span>`).join('');

      // Bot√≥n de ‚ÄúVer descripci√≥n‚Äù si hay descripci√≥n
      const hasDesc = !!stripHtml(b.descripcion || '').trim();
      const descBlock = b.descripcion
        ? `<div class="desc">${truncate(stripHtml(b.descripcion), 180)}</div>`
        : '';

      const descButton = hasDesc
        ? `<button class="btn ghost" onclick="openDescription('${esc(b.titulo)}','${esc(b.autor || '')}', \`${escMultiline(stripHtml(b.descripcion))}\`)">Ver descripci√≥n</button>`
        : '';

      return `
        <div class="card">
          <div class="cover-wrap">
            <a href="${esc(coverHref)}" target="_blank" rel="noopener">
              <img class="cover" src="${esc(portadaSrc)}" alt="Portada de ${esc(b.titulo)}"
                onerror="this.style.display='none';"/>
            </a>
          </div>
          <div class="content">
            <div class="title">${esc(b.titulo)}</div>
            <div class="author">por ${esc(b.autor || 'Autor desconocido')}</div>
            <div class="meta">
              ${year ? `<span>A√±o: ${year}</span>` : ''}
              ${b.editorial ? `<span>Editorial: ${esc(b.editorial)}</span>` : ''}
              ${series}
            </div>
            ${descBlock}
            <div class="meta">${genres}</div>

            <div class="formats">${tiles}</div>

            <div class="actions">
              <select id="${selectId}" class="format-select" onchange="updateViewer('${viewerId}','${selectId}')">
                ${options}
              </select>
              <button class="btn" onclick="openSelected('${selectId}')">Abrir</button>
              <button class="btn secondary" onclick="toggleViewer('${viewerId}','${selectId}')">Visor</button>
              ${descButton}
            </div>

            <iframe id="${viewerId}" class="viewer" loading="lazy"></iframe>
          </div>
        </div>
      `;
    }

    // Modal de descripci√≥n
    function openDescription(title, author, description) {
      const backdrop = document.getElementById('modalBackdrop');
      const titleEl = document.getElementById('modalTitle');
      const bodyEl = document.getElementById('modalBody');

      titleEl.textContent = author ? `${title} ‚Äî ${author}` : title;
      bodyEl.textContent = description || '(Sin descripci√≥n)';
      backdrop.style.display = 'flex';
      // Enfocar el bot√≥n cerrar para accesibilidad
      setTimeout(() => {
        const closeBtn = backdrop.querySelector('.modal-close');
        if (closeBtn) closeBtn.focus();
      }, 0);
    }

    function closeModal() {
      const backdrop = document.getElementById('modalBackdrop');
      backdrop.style.display = 'none';
    }

    // Visor embebido
    function buildPreviewUrl(viewUrl) {
      const m = String(viewUrl || '').match(/https:\/\/drive\.google\.com\/file\/d\/([^/]+)\/view/i);
      if (m && m[1]) {
        const id = m[1];
        return `https://drive.google.com/file/d/${id}/preview`;
      }
      return `https://docs.google.com/viewer?embedded=true&url=${encodeURIComponent(viewUrl || '')}`;
    }

    function toggleViewer(viewerId, selectId) {
      const iframe = document.getElementById(viewerId);
      if (!iframe) return;
      if (iframe.style.display === 'none' || !iframe.style.display) {
        updateViewer(viewerId, selectId);
        iframe.style.display = 'block';
      } else {
        iframe.style.display = 'none';
      }
    }

    function updateViewer(viewerId, selectId) {
      const iframe = document.getElementById(viewerId);
      const sel = document.getElementById(selectId);
      if (!iframe || !sel) return;
      const opt = sel.options[sel.selectedIndex];
      const preview = opt ? opt.getAttribute('data-preview') : '';
      if (!preview) {
        iframe.removeAttribute('src');
        iframe.style.display = 'none';
        return;
      }
      iframe.style.display = 'block';
      iframe.onerror = () => { iframe.style.display = 'none'; };
      iframe.src = preview;
    }

    function openSelected(selectId) {
      const sel = document.getElementById(selectId);
      if (!sel) return;
      const url = sel.value;
      if (!url) return;
      window.open(url, '_blank', 'noopener');
    }

    // Thumbnail de portada (Drive)
    function resolveCoverThumb(urlPortada) {
      if (!urlPortada) return '';
      const m = urlPortada.match(/\/d\/([^/]+)\//);
      const id = m ? m[1] : null;
      if (!id) return urlPortada;
      return `https://drive.google.com/thumbnail?id=${id}&sz=w400`;
    }

    // Utils
    function safeYear(dateStr) {
      if (!dateStr || dateStr.startsWith('0101')) return '';
      const d = new Date(dateStr);
      const y = d.getFullYear();
      return isNaN(y) ? '' : String(y);
    }
    function stripHtml(s){ return String(s || '').replace(/<[^>]+>/g,''); }
    function truncate(s,n){ return s.length>n ? s.slice(0,n)+'‚Ä¶' : s; }
    function esc(s){
      return String(s || '')
        .replace(/&/g,'&amp;').replace(/</g,'&lt;')
        .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
    }
    // Escapar para incrustar en template literal preservando saltos de l√≠nea
    function escMultiline(s) {
      return String(s || '').replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/\$/g,'\\$').replace(/\r?\n/g, '\\n');
    }
    function hash(s){ let h=0; for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i); h|=0;} return String(Math.abs(h)); }

    function showError(msg){
      const el = document.getElementById('noResults');
      el.style.display = 'block';
      el.textContent = msg;
    }
  </script>
</body>
</html>
