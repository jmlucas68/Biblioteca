<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mi Biblioteca Personal</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: #f5f7fb; margin:0; }
    .container { max-width: 1200px; margin: 0 auto; padding: 18px; }
    header { background:#1f2937; color:#fff; padding:18px; border-radius:12px; }
    header h1 { margin:0 0 6px 0; font-size:22px; }
    .stats { display:flex; gap:24px; font-size:14px; opacity:.9; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:14px; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; cursor:pointer; transition:all 0.2s; display:flex; flex-direction:column; }
    .card:hover { box-shadow:0 4px 12px rgba(0,0,0,.1); transform:translateY(-2px); }
    .card img { width:100%; height:160px; object-fit:cover; }
    .card h3 { margin:8px 12px 0 12px; font-size:16px; color:#111827; }
    .card p { margin:4px 12px 12px 12px; font-size:14px; color:#6b7280; }
    .controls { display:flex; gap:8px; flex-wrap:wrap; padding:12px 0; }
    .controls input, .controls select { padding:10px 12px; border-radius:8px; border:1px solid #cfd8e3; background:#fff; }
    .breadcrumb { display:flex; gap:6px; margin:12px 0; font-size:14px; color:#6b7280; }
    .breadcrumb span, .breadcrumb a { cursor:pointer; }
    .book-card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; }
    .book-card img { width:100%; height:200px; object-fit:cover; }
    .book-card .info { padding:12px; }
    .book-card h4 { margin:0 0 4px; font-size:15px; color:#111827; }
    .book-card .author { font-size:13px; color:#6b7280; }
    .tags { margin-top:6px; display:flex; flex-wrap:wrap; gap:6px; font-size:12px; }
    .tag { background:#eef2ff; padding:2px 6px; border-radius:8px; color:#4338ca; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ðŸ“š Mi Biblioteca Personal</h1>
      <div class="stats">
        <div>Total obras: <b id="statTotal">-</b></div>
        <div>Autores: <b id="statAuthors">-</b></div>
        <div>Secciones: <b id="statSections">-</b></div>
      </div>
    </header>

    <div id="breadcrumb" class="breadcrumb"></div>

    <!-- Vistas dinÃ¡micas -->
    <div id="sectionsView" class="grid"></div>
    <div id="subsectionsView" class="grid" style="display:none;"></div>
    <div id="booksView" style="display:none;">
      <div class="controls">
        <input id="q" type="search" placeholder="Buscar por tÃ­tulo, autor..." />
        <select id="author"><option value="">Todos los autores</option></select>
      </div>
      <div id="booksGrid" class="grid"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = 'https://fanyuclarbgwraiwbcmr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZhbnl1Y2xhcmJnd3JhaXdiY21yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNTczMzIsImV4cCI6MjA3MTYzMzMzMn0.AzELqTp0swLGcUxHqF_E7E6UZJcEKUdNcXFiPrMGr-Q';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let allBooks = [];
    let classification = {};
    let currentSection = null;
    let currentSubsection = null;

    document.addEventListener('DOMContentLoaded', async () => {
      // Cargar libros de Supabase
      const { data: booksData } = await supabase.from('books').select('*');
      allBooks = booksData.map(b => ({...b, _searchText:(b.titulo+" "+b.autor+" "+b.genero).toLowerCase()}));
      document.getElementById('statTotal').textContent = allBooks.length;

      // Cargar clasificaciÃ³n desde archivo local
      const res = await fetch('clasificacion.json');
      const jsonText = await res.text();
      const clean = jsonText.replace(/^classification\s*=\s*/, '');
      classification = JSON.parse(clean).sections;

      document.getElementById('statSections').textContent = Object.keys(classification).length;
      showSections();

      document.getElementById('q').addEventListener('input', renderBooks);
      document.getElementById('author').addEventListener('change', renderBooks);
    });

    function setBreadcrumb() {
      const bc = document.getElementById('breadcrumb');
      bc.innerHTML = '';
      if (!currentSection) return;
      const sec = document.createElement('a');
      sec.textContent = classification[currentSection].name;
      sec.onclick = () => { currentSubsection=null; showSubsections(currentSection); };
      bc.appendChild(sec);
      if (currentSubsection) {
        bc.innerHTML += ' â€º ';
        const sub = document.createElement('span');
        sub.textContent = classification[currentSection].subsections[currentSubsection].name;
        bc.appendChild(sub);
      }
    }

    function showSections() {
      currentSection = null;
      currentSubsection = null;
      document.getElementById('sectionsView').style.display='grid';
      document.getElementById('subsectionsView').style.display='none';
      document.getElementById('booksView').style.display='none';
      document.getElementById('breadcrumb').innerHTML='';
      const grid = document.getElementById('sectionsView');

      grid.innerHTML = Object.entries(classification).map(([secKey, sec]) => {
        let totalBooksInSection = 0;
        Object.values(sec.subsections).forEach(sub => {
          const tags = sub.tags.map(t=>t.toLowerCase());
          const count = allBooks.filter(b=> tags.some(t=>b._searchText.includes(t)) ).length;
          totalBooksInSection += count;
        });
        const totalSubsections = Object.keys(sec.subsections).length;
        return `
          <div class="card" onclick="showSubsections('${secKey}')">
            <img src="biblioteca.jpg" alt="Biblioteca" />
            <h3>${sec.name}</h3>
            <p>${totalSubsections} subseccion${totalSubsections!==1?'es':''} Â· ${totalBooksInSection} libro${totalBooksInSection!==1?'s':''}</p>
          </div>`;
      }).join('');
    }

    function showSubsections(sectionKey) {
      currentSection = sectionKey;
      currentSubsection = null;
      document.getElementById('sectionsView').style.display='none';
      document.getElementById('subsectionsView').style.display='grid';
      document.getElementById('booksView').style.display='none';
      setBreadcrumb();
      const grid = document.getElementById('subsectionsView');
      const subs = classification[sectionKey].subsections;

      grid.innerHTML = Object.entries(subs).map(([key,sub])=>{
        const tags = sub.tags.map(t=>t.toLowerCase());
        const count = allBooks.filter(b=> tags.some(t=>b._searchText.includes(t)) ).length;
        return `
          <div class="card" onclick="showBooks('${key}')">
            <img src="biblioteca.jpg" alt="Biblioteca" />
            <h3>${sub.name}</h3>
            <p>${count} libro${count!==1?'s':''}</p>
          </div>`;
      }).join('');
    }

    function showBooks(subKey) {
      currentSubsection = subKey;
      document.getElementById('sectionsView').style.display='none';
      document.getElementById('subsectionsView').style.display='none';
      document.getElementById('booksView').style.display='block';
      setBreadcrumb();
      renderBooks();
    }

    function renderBooks() {
      const q = document.getElementById('q').value.toLowerCase();
      const author = document.getElementById('author').value;
      const tags = classification[currentSection].subsections[currentSubsection].tags.map(t=>t.toLowerCase());

      const filtered = allBooks.filter(b=>{
        if (!tags.some(t=>b._searchText.includes(t))) return false;
        if (q && !b._searchText.includes(q)) return false;
        if (author && b.autor !== author) return false;
        return true;
      });

      const sel = document.getElementById('author');
      while (sel.children.length>1) sel.removeChild(sel.lastChild);
      [...new Set(filtered.map(b=>b.autor))].sort().forEach(a=>{
        if(a){ let opt=document.createElement('option'); opt.value=a; opt.textContent=a; sel.appendChild(opt);} });

      document.getElementById('booksGrid').innerHTML = filtered.map(b=>{
        const imgSrc = b.drive || b.imagen || 'biblioteca.jpg';
        return `
        <div class="book-card">
          <img src="${imgSrc}" alt="${b.titulo}" />
          <div class="info">
            <h4>${b.titulo}</h4>
            <div class="author">${b.autor||'Autor desconocido'}</div>
            <div class="tags">${tags.map(t=>`<span class="tag">${t}</span>`).join('')}</div>
          </div>
        </div>`;
      }).join('');
    }
  </script>
</body>
</html>
