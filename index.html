<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Biblioteca Personal - Clasificada</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="modal-backdrop" id="securityModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Acceso de Administrador</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Tipo de Usuario:</label>
                    <div class="user-type-selection">
                        <label class="radio-label">
                            <input type="radio" name="userType" value="Lector" checked>
                            <span class="radio-custom"></span>
                            Lector
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="userType" value="Bibliotecario">
                            <span class="radio-custom"></span>
                            Bibliotecario
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="passwordInput">Contrase√±a:</label>
                    <input type="password" id="passwordInput" class="form-control">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn--outline" onclick="closeLoginModal()">Cancelar</button>
                <button type="button" class="btn btn--primary" onclick="validatePassword()">Aceptar</button>
            </div>
        </div>
    </div>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-left">
                    <img src="images/logo.png" alt="Mi Biblioteca Personal Logo" class="header-logo">
                    <div class="breadcrumb" id="breadcrumb"></div>
                </div>
                <div class="header-right">
                    <button class="btn btn--primary" id="authButton" style="margin-right: 1rem;">
                        üîí Login
                    </button>
                    <!-- Bot√≥n Editar Clasificaci√≥n a la izquierda del de Buscar Libros -->
                    <button class="btn btn--warning admin-control" style="margin-right: 1rem; display: none;" onclick="openClassificationEditor()" title="Editar la estructura de clasificaci√≥n de secciones y tags">
                        ‚öôÔ∏è Editar Clasificaci√≥n
                    </button>
                    <button id="importButton" class="btn btn--primary admin-control" style="display: none; margin-right: 1rem;" title="Importar nuevos libros desde archivos">
                        üì• Importar Libros
                    </button>
                                        <button class="btn btn--outline" id="pinHeaderButton" title="Fijar/Desfijar cabecera">
                        üìå
                    </button>
                                        <div class="theme-switch-wrapper">
                        <label class="theme-switch" for="darkModeToggle">
                            <input type="checkbox" id="darkModeToggle" />
                            <span class="slider round"></span>
                        </label>
                        <span style="margin-left: 8px; color: var(--color-text-secondary);">Modo Oscuro</span>
                    </div>
                    <button class="header-search-btn" onclick="openSearchModal()">
                        üîç Buscar Libros
                    </button>
                    <div class="stats">
                        <div class="stat">
                            <span class="stat-number" id="totalBooks">0</span>
                            <span class="stat-label">Libros</span>
                        </div>
                        <div class="stat">
                            <span class="stat-number" id="totalAuthors">0</span>
                            <span class="stat-label">Autores</span>
                        </div>
                        <div class="stat">
                            <span class="stat-number" id="totalFormats">0</span>
                            <span class="stat-label">Formatos</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Admin Controls -->
        <div class="admin-controls" id="adminControls">
        </div>

        <!-- Controls -->
        <div class="controls" id="controls">
            <button class="btn btn--outline" id="backButton" style="display: none;">
                ‚Üê Volver
            </button>
            <div class="search-container" id="searchContainer" style="display: none;">
                <input type="text" class="form-control" id="searchInput" placeholder="Buscar libros...">
                <select class="form-control" id="sortSelect">
                    <option value="title">Ordenar por T√≠tulo</option>
                    <option value="author">Ordenar por Autor</option>
                    <option value="year">Ordenar por A√±o</option>
                </select>
            </div>
        </div>

        <!-- Loading -->
        <div class="loading" id="loading">
            Cargando biblioteca...
        </div>

        <!-- Views -->
        <div class="view" id="sectionsView">
            <div class="grid grid--sections" id="sectionsGrid"></div>
        </div>

        <div class="view" id="subsectionsView">
            <div class="grid grid--sections" id="subsectionsGrid"></div>
        </div>

        <div class="view" id="booksView">
            <div class="grid grid--books" id="booksGrid"></div>
        </div>

        <!-- Search Modal -->
        <div class="modal-backdrop" id="searchModal">
            <div class="modal modal--large">
                <div class="modal-header">
                    <h2 class="modal-title">üîç Buscar en tu Biblioteca</h2>
                    <button class="modal-close" onclick="closeSearchModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <!-- Search Form -->
                    <div class="form-group">
                        <label class="form-label" for="searchQuery">Buscar por t√≠tulo, autor, serie...</label>
                        <input type="text" id="searchQuery" class="form-control" placeholder="Escribe aqu√≠ tu b√∫squeda...">
                    </div>
                    
                    <!-- Search Option: Include Description -->
                    <div class="search-option">
                        <label class="checkbox-label">
                            <input type="checkbox" id="includeDescription" />
                            <span class="checkmark">‚úì</span>
                            Incluir descripci√≥n en la b√∫squeda
                        </label>
                    </div>
                    
                    <!-- Advanced Filters -->
                    <div class="search-filters">
                        <div class="form-group">
                            <label class="form-label" for="searchAutorInput">Autor</label>
                            <input type="text" id="searchAutorInput" class="form-control" placeholder="Escribe para filtrar autores...">
                            <select id="searchAutor" class="form-control" size="6" style="margin-top:6px;">
                                <option value="">Todos los autores</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="searchGeneroInput">G√©nero</label>
                            <input type="text" id="searchGeneroInput" class="form-control" placeholder="Escribe para filtrar g√©neros...">
                            <select id="searchGenero" class="form-control" size="6" style="margin-top:6px;">
                                <option value="">Todos los g√©neros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="searchSerie">Serie</label>
                            <select id="searchSerie" class="form-control">
                                <option value="">Todas las series</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="searchEditorial">Editorial</label>
                            <select id="searchEditorial" class="form-control">
                                <option value="">Todas las editoriales</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="searchYear">A√±o</label>
                            <select id="searchYear" class="form-control">
                                <option value="">Todos los a√±os</option>
                            </select>
                        </div>
                        <!-- Nuevo: Filtro por Formato -->
                        <div class="form-group">
                            <label class="form-label" for="searchFormato">Formato</label>
                            <select id="searchFormato" class="form-control">
                                <option value="">Todos</option>
                                <!-- Opciones de formato se rellenan din√°micamente -->
                            </select>
                        </div>
                    </div>
                    
                    <!-- Search Actions -->
                    <div class="search-actions">
                        <button type="button" class="btn btn--outline" onclick="clearSearch()">Limpiar</button>
                        <button type="button" class="btn btn--primary" onclick="performSearch()">üîç Buscar</button>
                        <button type="button" class="btn btn--secondary" id="randomBookButton" onclick="showRandomBookDetails()">üé≤ Libro Aleatorio</button>
                    </div>
                    
                    <!-- Search Results -->
                    <div id="searchResults" style="margin-top: 24px;">
                        <!-- Results will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de detalles -->
        <div class="modal-backdrop" id="bookModal">
            <div class="modal">
                <div class="modal-header">
                    <h2 class="modal-title">üìñ Detalles del libro</h2>
                    <button class="modal-close" id="closeModal">√ó</button>
                </div>
                <div class="modal-body" id="modalContent"></div>
            </div>
        </div>

        <!-- Visor de Libros -->
        <div class="modal-backdrop" id="viewerModal" style="z-index: 1010; display: none;">
             <div class="modal" style="max-width: 90vw; height: 90vh; display: flex; flex-direction: column;">
                <div class="modal-header">
                    <h2 class="modal-title" id="viewerTitle">Visor de Libros</h2>
                    <a id="viewerDownloadLink" href="#" target="_blank" class="btn btn--primary" style="margin-left: auto; margin-right: 1rem;">
                        ‚¨áÔ∏è Descargar
                    </a>
                    <button class="modal-close" onclick="closeViewer()">√ó</button>
                </div>
                <div class="modal-body" style="flex-grow: 1; padding: 0;">
                    <iframe id="viewerIframe" style="width: 100%; height: 100%; border: none;"></iframe>
                </div>
            </div>
        </div>

        <!-- Modal de edici√≥n -->
        <div class="modal-backdrop" id="editModal">
            <div class="modal">
                <div class="modal-header">
                    <h2 class="modal-title">‚úèÔ∏è Editar libro</h2>
                    <button class="modal-close" onclick="closeEditModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <div class="form-group">
                            <label for="editTitulo">T√≠tulo *</label>
                            <input
                                type="text"
                                class="form-control"
                                id="editTitulo"
                                name="titulo"
                                placeholder="Introduce el t√≠tulo"
                                required
                            >
                        </div>

                        
                        <div class="form-group">
                            <label class="form-label" for="editAutor">Autor</label>
                            <input type="text" id="editAutor" name="autor" class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">G√©neros</label>
                            <div id="current-book-tags" class="tags-container">
                                <!-- Las p√≠ldoras de los g√©neros actuales se insertar√°n aqu√≠ -->
                            </div>
                            <input type="text" id="genre-search-input" class="form-control" placeholder="Buscar o a√±adir g√©nero...">
                            <div id="genre-search-results" class="search-results-container">
                                <!-- Los resultados de la b√∫squeda de g√©neros se insertar√°n aqu√≠ -->
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="editSerie">Serie</label>
                            <input type="text" id="editSerie" name="serie" class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="editNumeroSerie">N√∫mero de serie</label>
                            <input type="text" id="editNumeroSerie" name="numero_serie" class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="editEditorial">Editorial</label>
                            <input type="text" id="editEditorial" name="editorial" class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="editFechaPublicacion">Fecha de publicaci√≥n</label>
                            <input type="date" id="editFechaPublicacion" name="fecha_publicacion" class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="editDescripcion">Descripci√≥n</label>
                            <textarea id="editDescripcion" name="descripcion" class="form-control" rows="4"></textarea>
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn btn--primary" id="aiDescriptionButton">Descripci√≥n IA</button>
                        
                        <div class="form-group">
                            <label class="form-label" for="editCarpetaObra">Carpeta de obra</label>
                            <input type="text" id="editCarpetaObra" name="carpeta_obra" class="form-control">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn--outline" onclick="closeEditModal()">Cancelar</button>
                    <button type="button" class="btn btn--success" onclick="saveBookChanges()">üíæ Guardar cambios</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Elementos para la importaci√≥n de archivos -->
    <input type="file" id="ebookImporter" accept=".epub,.mobi,.pdf,.azw3" style="display:none;" multiple>
    <div id="uploadStatus" class="upload-status"></div>

    <script src="script.js"></script>

    <!-- Modal para Importar Libro -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Detalles del Libro a Importar</h2>
            <form id="importForm">
                <label for="modalTitle">T√≠tulo:</label>
                <input type="text" id="modalTitle" required>

                <label for="modalAuthor">Autor:</label>
                <input type="text" id="modalAuthor" required>

                <label for="modalCategory">Categor√≠a:</label>
                <input type="text" id="modalCategory" required>

                <label for="modalDescription">Descripci√≥n:</label>
                <textarea id="modalDescription"></textarea>

                <button type="submit">Guardar Libro</button>
            </form>
        </div>
    </div>
</body>
</html>