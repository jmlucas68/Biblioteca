<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Biblioteca App</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:Arial,sans-serif; background:#f5f5f5; }
    .container { max-width:1200px; margin:0 auto; padding:20px; }
    h1 { text-align:center; margin-bottom:30px; color:#333; }
    
    .nav-buttons { display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
    .nav-buttons button { padding:10px 20px; border:none; background:#007bff; color:white; border-radius:5px; cursor:pointer; }
    .nav-buttons button:hover { background:#0056b3; }
    .nav-buttons button.active { background:#28a745; }
    
    .search-filters { display:flex; gap:10px; margin-bottom:20px; align-items:center; flex-wrap:wrap; }
    .search-filters input, .search-filters select { padding:8px; border:1px solid #ddd; border-radius:4px; }
    .search-filters input[type="text"] { flex:1; min-width:200px; }
    
    .sections-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:20px; margin-bottom:20px; }
    .card { background:white; padding:20px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); cursor:pointer; transition:transform 0.2s; }
    .card:hover { transform:translateY(-2px); }
    .card img { width:100%; height:160px; object-fit:cover; }
    .card h3 { margin:10px 0; color:#333; }
    .card p { color:#666; font-size:14px; }
    
    .subsections-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:15px; margin-bottom:20px; }
    .subsection-card { background:white; padding:15px; border-radius:6px; box-shadow:0 1px 5px rgba(0,0,0,0.1); cursor:pointer; }
    .subsection-card:hover { background:#f8f9fa; }
    .subsection-card h4 { color:#007bff; margin-bottom:5px; }
    .subsection-card p { color:#666; font-size:13px; }
    
    .books-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:15px; }
    .book-card { background:white; border-radius:6px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    .book-card img { width:100%; height:200px; object-fit:cover; }
    .book-card .info { padding:15px; }
    .book-card h4 { margin-bottom:8px; color:#333; font-size:14px; }
    .book-card .author { color:#666; font-size:12px; margin-bottom:8px; }
    .book-card .tags { display:flex; gap:5px; flex-wrap:wrap; }
    .tag { background:#e9ecef; padding:2px 6px; border-radius:3px; font-size:10px; color:#495057; }
    
    .back-button { margin-bottom:20px; }
    .back-button button { padding:8px 16px; border:none; background:#6c757d; color:white; border-radius:4px; cursor:pointer; }
    .back-button button:hover { background:#545b62; }
    
    .hidden { display:none; }
    .books-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    .books-count { color:#666; font-size:14px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìö Biblioteca Digital</h1>
    
    <div id="sectionsView">
      <div class="sections-grid" id="sectionsGrid"></div>
    </div>
    
    <div id="subsectionsView" class="hidden">
      <div class="back-button">
        <button onclick="showSections()">‚Üê Volver a Secciones</button>
      </div>
      <h2 id="sectionTitle"></h2>
      <div class="subsections-grid" id="subsectionsGrid"></div>
    </div>
    
    <div id="booksView" class="hidden">
      <div class="back-button">
        <button onclick="showSubsections()">‚Üê Volver a Subsecciones</button>
      </div>
      
      <div class="books-header">
        <h2 id="booksTitle"></h2>
        <div class="books-count" id="booksCount"></div>
      </div>
      
      <div class="search-filters">
        <input type="text" id="q" placeholder="Buscar libros...">
        <select id="author">
          <option value="">Todos los autores</option>
        </select>
        <button onclick="renderBooks()" style="padding:8px 16px;border:none;background:#007bff;color:white;border-radius:4px;cursor:pointer;">Buscar</button>
      </div>
      
      <div class="books-grid" id="booksGrid"></div>
    </div>
  </div>

  <script>
    // Configuraci√≥n de Supabase - REEMPLAZA con tus credenciales reales
    const supabaseUrl = 'https://tu-proyecto.supabase.co'
    const supabaseKey = 'tu-clave-publica-anonima'
    const supabase = supabase.createClient(supabaseUrl, supabaseKey)

    let allBooks = [];
    let classification = {};
    let currentSection = null;
    let currentSubsection = null;

    document.addEventListener('DOMContentLoaded', async () => {
      // Cargar libros de Supabase
      const { data: booksData } = await supabase.from('books').select('*');
      allBooks = booksData.map(b => ({...b, _searchText:(b.titulo+" "+b.autor+" "+b.genero).toLowerCase()}));

      // Cargar clasificaci√≥n desde archivo local
      const res = await fetch('clasificacion.json');
      const jsonText = await res.text();
      const clean = jsonText.replace(/\/\*[\s\S]*?\*\//g, '').replace(/\/\/.*$/gm, '');
      classification = JSON.parse(clean);
      
      showSections();
      
      // Event listeners para b√∫squeda
      document.getElementById('q').addEventListener('input', renderBooks);
      document.getElementById('author').addEventListener('change', renderBooks);
    });

    function showSections() {
      document.getElementById('sectionsView').classList.remove('hidden');
      document.getElementById('subsectionsView').classList.add('hidden');
      document.getElementById('booksView').classList.add('hidden');
      
      const grid = document.getElementById('sectionsGrid');
      grid.innerHTML = Object.entries(classification).map(([secKey, sec]) => {
        let totalBooksInSection = 0;
        Object.values(sec.subsections).forEach(sub => {
          const tags = sub.tags.map(t=>t.toLowerCase());
          const count = allBooks.filter(b=> tags.some(t=>b._searchText.includes(t)) ).length;
          totalBooksInSection += count;
        });
        const totalSubsections = Object.keys(sec.subsections).length;
        return `
          <div class="card" onclick="showSubsections('${secKey}')">
            <img src="biblioteca.jpg" alt="Biblioteca" />
            <h3>${sec.name}</h3>
            <p>${totalSubsections} subseccion${totalSubsections!==1?'es':''} ¬∑ ${totalBooksInSection} libro${totalBooksInSection!==1?'s':''}</p>
          </div>`;
      }).join('');
    }

    function showSubsections(sectionKey) {
      currentSection = sectionKey;
      const section = classification[sectionKey];
      
      document.getElementById('sectionsView').classList.add('hidden');
      document.getElementById('subsectionsView').classList.remove('hidden');
      document.getElementById('booksView').classList.add('hidden');
      
      document.getElementById('sectionTitle').textContent = section.name;
      
      const grid = document.getElementById('subsectionsGrid');
      grid.innerHTML = Object.entries(section.subsections).map(([key, sub]) => {
        const tags = sub.tags.map(t=>t.toLowerCase());
        const count = allBooks.filter(b=> tags.some(t=>b._searchText.includes(t)) ).length;
        return `
          <div class="subsection-card" onclick="showBooks('${key}')">
            <h4>${sub.name}</h4>
            <p>${count} libro${count!==1?'s':''}</p>
          </div>`;
      }).join('');
    }

    function showBooks(subsectionKey) {
      currentSubsection = subsectionKey;
      const subsection = classification[currentSection].subsections[subsectionKey];
      
      document.getElementById('subsectionsView').classList.add('hidden');
      document.getElementById('booksView').classList.remove('hidden');
      
      document.getElementById('booksTitle').textContent = subsection.name;
      document.getElementById('q').value = '';
      document.getElementById('author').value = '';
      
      renderBooks();
    }

    function renderBooks() {
      const q = document.getElementById('q').value.toLowerCase();
      const author = document.getElementById('author').value;
      const tags = classification[currentSection].subsections[currentSubsection].tags.map(t=>t.toLowerCase());

      const filtered = allBooks.filter(b=>{
        if (!tags.some(t=>b._searchText.includes(t))) return false;
        if (q && !b._searchText.includes(q)) return false;
        if (author && b.autor !== author) return false;
        return true;
      });

      const sel = document.getElementById('author');
      while (sel.children.length>1) sel.removeChild(sel.lastChild);
      [...new Set(filtered.map(b=>b.autor))].sort().forEach(a=>{
        if(a){ let opt=document.createElement('option'); opt.value=a; opt.textContent=a; sel.appendChild(opt);} });

      document.getElementById('booksGrid').innerHTML = filtered.map(b=>{
        // Mejorar el manejo de la imagen con validaci√≥n de campos vac√≠os
        const getValidUrl = (url) => {
          if (!url) return null;
          const trimmed = String(url).trim();
          return trimmed && trimmed !== 'null' && trimmed !== 'undefined' ? trimmed : null;
        };
        const imgSrc = getValidUrl(b.url_portada) || 
                      getValidUrl(b.drive) || 
                      getValidUrl(b.imagen) || 
                      'biblioteca.jpg';
        return `
        <div class="book-card">
          <img src="${imgSrc}" alt="${b.titulo}" loading="lazy" onerror="this.onerror=null;this.src='biblioteca.jpg';" />
          <div class="info">
            <h4>${b.titulo}</h4>
            <div class="author">${b.autor||'Autor desconocido'}</div>
            <div class="tags">${tags.map(t=>`<span class="tag">${t}</span>`).join('')}</div>
          </div>
        </div>`;
      }).join('');

      document.getElementById('booksCount').textContent = `${filtered.length} libro${filtered.length!==1?'s':''}`;
    }
  </script>
</body>
</html>