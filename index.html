<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Listado de Libros</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; }
    h1 { margin-bottom: 20px; }
    .toolbar { display: flex; gap: 12px; margin-bottom: 12px; }
    .toolbar input[type="search"], .toolbar select { padding: 7px 10px; }
    .toolbar button { padding: 7px 16px; }
    table { width: 100%; border-collapse: collapse; background: #fff; }
    thead th { background: #f2f4f8; border-bottom: 1px solid #ccc; text-align: left; padding: 8px; }
    tbody td { padding: 8px; border-top: 1px solid #eee; }
    .right { text-align: right; }
    .pager { display: flex; gap: 8px; align-items: center; margin-top: 8px; }
    .muted { color: #888; font-size: 14px; }
    #loading { margin-left: 8px; font-size: 13px; }
    .hidden { display: none; }
    .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid #bbb; border-top-color: #333; border-radius: 50%; animation: spin 0.8s linear infinite; vertical-align: text-bottom; }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* Modal styles */
    .modal-bg {
      position: fixed; top: 0; left: 0; width:100vw; height:100vh;
      background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;
      z-index: 2000; 
    }
    .modal-content {
      background: #fff; border-radius: 8px; padding: 24px 28px; min-width: 320px; box-shadow: 0 2px 24px #4441;
      position: relative;
    }
    .modal-content h2 { margin-top: 0; margin-bottom: 16px; }
    .modal-form label { display: block; margin: 12px 0 5px; font-weight: bold;}
    .modal-form input, .modal-form textarea { width: 100%; padding: 7px; margin-bottom: 12px; }
    .modal-form textarea { resize: vertical; }
    .modal-actions { display: flex; gap: 12px; justify-content: flex-end; }
  </style>
</head>
<body>
  <h1>Listado de Libros</h1>
  <div class="toolbar">
    <input id="q" type="search" placeholder="Buscar..." autocomplete="off" />
    <button id="refreshBtn" title="Recargar manualmente desde el servidor">Refrescar</button>
    <select id="pageSize">
      <option value="10">10 filas</option>
      <option value="25">25 filas</option>
      <option value="50">50 filas</option>
      <option value="100">100 filas</option>
    </select>
    <span id="loading" class="hidden"><span class="spinner"></span> Cargando...</span>
  </div>
  <div style="overflow-x:auto; max-height: 65vh; border:1px solid #eee;">
    <table id="grid">
      <thead>
        <tr>
          <th data-key="id">ID</th>
          <th data-key="titulo">Título</th>
          <th data-key="autor">Autor</th>
          <th data-key="categoria">Categoría</th>
          <th data-key="fecha">Fecha</th>
          <th data-key="drive">Enlace Drive</th>
          <th>Editar</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="pager">
    <button id="prev">Anterior</button>
    <span id="pageInfo" class="muted"></span>
    <button id="next">Siguiente</button>
  </div>

  <!-- Modal para editar -->
  <div id="modalEdit" class="modal-bg hidden">
    <div class="modal-content">
      <h2>Editar libro</h2>
      <form class="modal-form">
        <label>ID</label>
        <input type="text" id="modalId" disabled />
        <label>Título</label>
        <input type="text" id="modalTitulo" required />

        <label>Autor</label>
        <input type="text" id="modalAutor" required />

        <label>Categoría</label>
        <input type="text" id="modalCategoria" required />

        <label>Fecha</label>
        <input type="date" id="modalFecha" required />

        <!-- El enlace de Drive se muestra pero no se puede editar -->
        <label>Enlace Drive</label>
        <input type="text" id="modalDrive" disabled />

        <div class="modal-actions">
          <button type="button" id="saveEdit">Guardar</button>
          <button type="button" id="cancelEdit">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let ALL_ROWS = [];
    let VIEW_ROWS = [];
    let sortKey = null;
    let sortDir = 1;
    let page = 1;
    let pageSize = 10;
    let editRowIndex = null; // índice de edición en ALL_ROWS

    function escapeHTML(v) {
      return String(v ?? "").replace(/[&<>"']/g, s => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[s]));
    }
    function showLoading(on) {
      document.getElementById("loading").classList.toggle("hidden", !on);
    }
    async function fetchAllRows() {
      showLoading(true);
      try {
        const res = await fetch('/api/tabla-completa');
        if (!res.ok) throw new Error("Error " + res.status);
        return await res.json();
      } finally {
        showLoading(false);
      }
    }
    function applyFilterSort() {
      const q = document.getElementById('q').value.trim().toLowerCase();
      VIEW_ROWS = ALL_ROWS.filter(row => {
        if (!q) return true;
        return Object.values(row).some(val => String(val ?? "").toLowerCase().includes(q));
      });
      if (sortKey) {
        VIEW_ROWS.sort((a, b) => {
          let av = a[sortKey], bv = b[sortKey];
          if (!isNaN(av) && !isNaN(bv)) {
            return (Number(av) - Number(bv)) * sortDir;
          } else {
            av = String(av ?? "").toLowerCase();
            bv = String(bv ?? "").toLowerCase();
            return av.localeCompare(bv) * sortDir;
          }
        });
      }
    }
    function renderTable() {
      applyFilterSort();
      const total = VIEW_ROWS.length;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      if (page > totalPages) page = totalPages;
      const start = (page - 1) * pageSize;
      const items = VIEW_ROWS.slice(start, start + pageSize);
      const tbody = document.querySelector("#grid tbody");
      tbody.innerHTML = items.map(row => `
        <tr>
          <td>${escapeHTML(row.id)}</td>
          <td>${escapeHTML(row.titulo)}</td>
          <td>${escapeHTML(row.autor)}</td>
          <td>${escapeHTML(row.categoria)}</td>
          <td>${escapeHTML(row.fecha)}</td>
          <td>${row.drive ? `<a href="${escapeHTML(row.drive)}" target="_blank">Ver</a>` : ""}</td>
          <td><button class="editBtn" data-id="${row.id}">Editar</button></td>
        </tr>
      `).join("");
      document.getElementById("pageInfo").textContent = `Página ${page} de ${totalPages} · ${total} filas`;
      // Eventos para botones de editar
      document.querySelectorAll(".editBtn").forEach(btn => {
        btn.onclick = () => openEditDialog(btn.getAttribute('data-id'));
      });
    }
    function attachEvents() {
      document.getElementById("q").addEventListener("input", () => { page = 1; renderTable(); });
      document.getElementById("prev").addEventListener("click", () => { if (page > 1) page--; renderTable(); });
      document.getElementById("next").addEventListener("click", () => { page++; renderTable(); });
      document.getElementById("pageSize").addEventListener("change", function (e) {
        pageSize = Number(e.target.value) || 10;
        page = 1;
        renderTable();
      });
      document.querySelectorAll("#grid thead th").forEach(th => {
        const key = th.dataset.key;
        if (!key) return;
        th.addEventListener("click", () => {
          if (sortKey === key) sortDir = -1 * sortDir;
          else { sortKey = key; sortDir = 1; }
          renderTable();
        });
      });
      document.getElementById("refreshBtn").addEventListener("click", async () => {
        ALL_ROWS = await fetchAllRows();
        page = 1;
        renderTable();
      });
      document.getElementById("cancelEdit").onclick = closeEditDialog;
      document.getElementById("saveEdit").onclick = saveEditDialog;
      // Cierrra modal con escape
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") closeEditDialog();
      });
      document.getElementById("modalEdit").onclick = function(e) {
        if (e.target === this) closeEditDialog();
      }
    }
    function openEditDialog(id) {
      editRowIndex = ALL_ROWS.findIndex(r => String(r.id) === String(id));
      if (editRowIndex === -1) return;
      const row = ALL_ROWS[editRowIndex];
      document.getElementById("modalId").value = row.id ?? '';
      document.getElementById("modalTitulo").value = row.titulo ?? '';
      document.getElementById("modalAutor").value = row.autor ?? '';
      document.getElementById("modalCategoria").value = row.categoria ?? '';
      document.getElementById("modalFecha").value = row.fecha ?? '';
      document.getElementById("modalDrive").value = row.drive ?? '';
      document.getElementById("modalEdit").classList.remove("hidden");
    }
    function closeEditDialog() {
      document.getElementById("modalEdit").classList.add("hidden");
    }
    function saveEditDialog() {
      if (editRowIndex === null || editRowIndex < 0) return;
      // Valida
      const newRow = {
        ...ALL_ROWS[editRowIndex],
        titulo: document.getElementById("modalTitulo").value.trim(),
        autor: document.getElementById("modalAutor").value.trim(),
        categoria: document.getElementById("modalCategoria").value.trim(),
        fecha: document.getElementById("modalFecha").value.trim(),
        // drive no se cambia
      };
      // Actualiza en memoria
      ALL_ROWS[editRowIndex] = newRow;
      closeEditDialog();
      renderTable();
      // Si quieres guardar en backend, envía una petición fetch aquí.
    }
    (async function init() {
      attachEvents();
      ALL_ROWS = await fetchAllRows();
      renderTable();
    })();
  </script>
</body>
</html>
